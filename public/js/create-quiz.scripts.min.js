var isQuizNameValid = true;
var questions = [];
var currentQuestionNum = 1;
var selectedQuestionIndex = 0;
var currentModalContext = null;

function resetQuizVariables() {
	questions = [];
	currentQuestionNum = 1;
	isQuizNameValid = true;
}

function onQuizNameInput(quizName) {
	document.getElementById("blank-name-alert").style.display = "none";

	isQuizNameValid = !quizName.match(INVALID_NAME_PATTERN);
	document.getElementById("invalid-name-alert").style.display = isQuizNameValid ?
		"none" :
		"block";
}

function updateNavButtons() {
	document.getElementById("prev-question-btn").style.visibility =
		(selectedQuestionIndex > 0) ? "visible" : "hidden";
	document.getElementById("next-question-btn").style.visibility = 
		(selectedQuestionIndex < questions.length) ? "visible" : "hidden";
}

function populateFields(currentQuestion) {
	var question = (currentQuestion || 
		{ "question-text": "", "responses": ["", "", "", ""], "correct-response-index": -1 });

	document.getElementById("question-text-input").value = question["question-text"];
	for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT; i++) {
		document.getElementById("response-" + i + "-input").value = question["responses"][i - 1];
	}

	var checkedOption = document.querySelector("input[name='correct-response']:checked");
	if (checkedOption) {
		checkedOption.checked = false;
	}
	if (question["correct-response-index"] >= 0) {
		var optNumber = question["correct-response-index"] + 1;
		document.getElementById("correct-opt-" + optNumber).checked = true;
	}
}

function performNavigation(indexChange) {
	selectedQuestionIndex += indexChange;
	currentQuestionNum = selectedQuestionIndex + 1;
	refreshView();
	updateNavButtons();
	setQuestionTitle();
}
function navigateQuestions(indexChange) {
	if (selectedQuestionIndex === questions.length) {
		performNavigation(indexChange);
		populateFields(questions[selectedQuestionIndex]);
	}
	else if (verifyCurrentQuestion()){
		addCurrentQuestionToQuiz(selectedQuestionIndex);
		performNavigation(indexChange)

		var question = (selectedQuestionIndex >= questions.length) ?
			null : 
			questions[selectedQuestionIndex];
		populateFields(questions[selectedQuestionIndex])
	}
}

function isStringNullOrEmpty(value) {
	return (!value || value.trim() === "");
}
function getQuestionText() {
	return document.getElementById("question-text-input").value;
}
function getResponseInputs() {
	var responses = [];
	isResponsesEntered = true;
	for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT && isResponsesEntered; i++) {
		var responseValue = document.getElementById("response-" + i + "-input").value;
		if (isStringNullOrEmpty(responseValue)) {
			isResponsesEntered = false;
			responses = [];
		}
		else { 
			responses.push(responseValue);
		}
	}
	return responses;
}
function getCorrectResponseIndex() {
	var selectedButton = document.querySelector("input[name='correct-response']:checked");
	var buttons = document.querySelectorAll("input[name='correct-response']");
	var buttonsArray = Array.from(buttons);
	return selectedButton ? buttonsArray.indexOf(selectedButton) : -1;
}
function verifyCurrentQuestion() {
	var isComplete = true;

	if (isStringNullOrEmpty(getQuestionText())) {
		isComplete = false;
		document.getElementById("blank-question-text-alert").style.display = "block";
	}
	if (getResponseInputs().length === 0) {
		isComplete = false;
		document.getElementById("blank-responses-alert").style.display = "block";
	}
	if (getCorrectResponseIndex() < 0) {
		isComplete = false;
		document.getElementById("blank-correct-response-alert").style.display = "block";
	}

	return isComplete;
}
function verifyQuizName() {
	var isQuizNamePresent = true;

	var quizName = document.getElementById("quiz-name-input").value;
	if (isStringNullOrEmpty(quizName)) {
		isQuizNamePresent = false;
		document.getElementById("blank-name-alert").style.display = "block";
	}

	return isQuizNamePresent && isQuizNameValid;
}

function clearQuestionInputs() {
	document.getElementById("question-text-input").value = "";
	for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT; i++) {
		document.getElementById("response-" + i + "-input").value = "";
	}

	var checkedOption = document.querySelector("input[name='correct-response']:checked");
	if (checkedOption) {
		checkedOption.checked = false;
	}
}

function refreshView() {
	document.getElementById("blank-name-alert").style.display = "none";
	document.getElementById("blank-question-text-alert").style.display = "none";
	document.getElementById("blank-responses-alert").style.display = "none";
	document.getElementById("blank-correct-response-alert").style.display = "none";

	window.scrollTo(0, 0);
}

function addCurrentQuestionToQuiz(questionIndex) {
	var question = {
		"question-id": currentQuestionNum,
		"question-text": getQuestionText(),
		"responses": getResponseInputs(),
		"correct-response-index": getCorrectResponseIndex()
	};
	if (typeof questionIndex === "undefined" || questionIndex < 0 || questionIndex >= questions.length) {
		questions.push(question);
	}
	else {
		questions[questionIndex] = question;
	}
}

function setQuestionTitle () {
	document.getElementById("question-title").innerHTML = "Question #" + (selectedQuestionIndex + 1);
}

function showConfirmationModal(modalType) {
	currentModalContext = modalType;
	var quizModalProps = QUIZ_MODAL_ACTIONS[modalType];
	document.getElementById("confirmation-modal-title").innerHTML = quizModalProps["title"];
	document.getElementById("confirmation-modal-text").innerHTML = quizModalProps["text"];
	document.getElementById("confirm-button").innerHTML = quizModalProps["button-text"];
	document.getElementById("confirm-button").classList = "btn btn-" + quizModalProps["button-class"];
	$("#confirmation-modal").modal();
}
function onConfirmClick() {
	if (currentModalContext === "delete") {
		window.location.href = "/";
	}
	else if (currentModalContext === "publish") {
		console.log("published: " + JSON.stringify(questions));
	}
	else {
		alert("JavaScript error: Modal was expected to be open but none was found.")
	}

	resetQuizVariables();
}

function onDeleteQuizClick() {
	refreshView();
	showConfirmationModal("delete");
}
function onDeleteQuestionClick() {
	refreshView();

	if (selectedQuestionIndex >= 0 && selectedQuestionIndex < questions.length) {
		questions.splice(selectedQuestionIndex, 1);
		if (selectedQuestionIndex > 0) {
			selectedQuestionIndex -= 1;
			currentQuestionNum -= 1;
		}
		setQuestionTitle();

		var question = (selectedQuestionIndex < questions.length) ?
			questions[selectedQuestionIndex] :
			{ "question-text": "", "responses": ["", "", "", ""], "correct-response-index": -1 }
		document.getElementById("question-text-input").value = question["question-text"];
		for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT; i++) {
			document.getElementById("response-" + i + "-input").value = question["responses"][i - 1];
		}

		var checkedOption = document.querySelector("input[name='correct-response']:checked");
		if (checkedOption) {
			checkedOption.checked = false;
		}
		if (question["correct-response-index"] >= 0) {
			var optNumber = question["correct-response-index"] + 1;
			document.getElementById("correct-opt-" + optNumber).checked = true;
		}

		updateNavButtons();
	}
	else if (selectedQuestionIndex >= questions.length) {
		clearQuestionInputs();
	}
}

function isLastQuestionBlank() {
	return (isStringNullOrEmpty(getQuestionText()) &&
		getResponseInputs().length === 0 &&
		getCorrectResponseIndex() < 0);
}

function updateInputFields() {
	setQuestionTitle();
	clearQuestionInputs();
	updateNavButtons();
}
function onAddQuestionClick() {
	refreshView();

	if (selectedQuestionIndex < questions.length) {
		selectedQuestionIndex = questions.length;
		currentQuestionNum = selectedQuestionIndex + 1;
		updateInputFields();
	}
	else if (verifyCurrentQuestion()) {
		addCurrentQuestionToQuiz();
		selectedQuestionIndex += 1;
		currentQuestionNum += 1;
		updateInputFields();
	}
}
function onPublishQuizClick() {
	refreshView();
	if (verifyQuizName()) {
		if (isLastQuestionBlank() || selectedQuestionIndex < questions.length) {
			showConfirmationModal("publish");
		}
		else if (verifyCurrentQuestion()){
			addCurrentQuestionToQuiz();
			showConfirmationModal("publish");
		}
	}
}
