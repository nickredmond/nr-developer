var isQuizNameValid = true;
var questions = [];
var currentQuestionNum = 1;
var currentModalContext = null;

function resetQuizVariables() {
	questions = [];
	currentQuestionNum = 1;
	isQuizNameValid = true;
}

function onQuizNameInput(quizName) {
	document.getElementById("blank-name-alert").style.display = "none";

	isQuizNameValid = !quizName.match(INVALID_NAME_PATTERN);
	document.getElementById("invalid-name-alert").style.display = isQuizNameValid ?
		"none" :
		"block";
}

function isStringNullOrEmpty(value) {
	return (!value || value.trim() === "");
}
function getQuestionText() {
	return document.getElementById("question-text-input").value;
}
function getResponseInputs() {
	var responses = [];
	isResponsesEntered = true;
	for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT && isResponsesEntered; i++) {
		var responseValue = document.getElementById("response-" + i + "-input").value;
		if (isStringNullOrEmpty(responseValue)) {
			isResponsesEntered = false;
			responses = [];
		}
		else { 
			responses.push(responseValue);
		}
	}
	return responses;
}
function getCorrectResponseIndex() {
	var selectedButton = document.querySelector("input[name='correct-response']:checked");
	var buttons = document.querySelectorAll("input[name='correct-response']");
	var buttonsArray = Array.from(buttons);
	return selectedButton ? buttonsArray.indexOf(selectedButton) : -1;
}
function verifyCurrentQuestion() {
	var isComplete = true;

	if (isStringNullOrEmpty(getQuestionText())) {
		isComplete = false;
		document.getElementById("blank-question-text-alert").style.display = "block";
	}
	if (getResponseInputs().length === 0) {
		isComplete = false;
		document.getElementById("blank-responses-alert").style.display = "block";
	}
	if (getCorrectResponseIndex() < 0) {
		isComplete = false;
		document.getElementById("blank-correct-response-alert").style.display = "block";
	}

	return isComplete;
}
function verifyQuizName() {
	var isQuizNamePresent = true;

	var quizName = document.getElementById("quiz-name-input").value;
	if (isStringNullOrEmpty(quizName)) {
		isQuizNamePresent = false;
		document.getElementById("blank-name-alert").style.display = "block";
	}

	return isQuizNamePresent && isQuizNameValid;
}

function clearQuestionInputs() {
	document.getElementById("question-text-input").value = "";
	for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT; i++) {
		document.getElementById("response-" + i + "-input").value = "";
	}

	var checkedOption = document.querySelector("input[name='correct-response']:checked");
	if (checkedOption) {
		checkedOption.checked = false;
	}
}

function refreshView() {
	document.getElementById("blank-name-alert").style.display = "none";
	document.getElementById("blank-question-text-alert").style.display = "none";
	document.getElementById("blank-responses-alert").style.display = "none";
	document.getElementById("blank-correct-response-alert").style.display = "none";

	window.scrollTo(0, 0);
}

function addCurrentQuestionToQuiz() {
	var question = {
		"question-id": currentQuestionNum,
		"question-text": getQuestionText(),
		"responses": getResponseInputs(),
		"correct-response-index": getCorrectResponseIndex()
	};
	questions.push(question);
}

function setQuestionTitle () {
	document.getElementById("question-title").innerHTML = "Question #" + currentQuestionNum;
}

function showConfirmationModal(modalType) {
	currentModalContext = modalType;
	var quizModalProps = QUIZ_MODAL_ACTIONS[modalType];
	document.getElementById("confirmation-modal-title").innerHTML = quizModalProps["title"];
	document.getElementById("confirmation-modal-text").innerHTML = quizModalProps["text"];
	document.getElementById("confirm-button").innerHTML = quizModalProps["button-text"];
	document.getElementById("confirm-button").classList = "btn btn-" + quizModalProps["button-class"];
	$("#confirmation-modal").modal();
}
function onConfirmClick() {
	if (currentModalContext === "delete") {
		window.location.href = "/";
	}
	else if (currentModalContext === "publish") {
		console.log("published: " + JSON.stringify(questions));
	}
	else {
		alert("JavaScript error: Modal was expected to be open but none was found.")
	}

	resetQuizVariables();
}

function onDeleteQuizClick() {
	refreshView();
	showConfirmationModal("delete");
}
function onDeleteQuestionClick() {
	refreshView();

	if (currentQuestionNum > 1) {
		var lastQuestion = questions.pop();
		currentQuestionNum -= 1;
		setQuestionTitle();
		document.getElementById("question-text-input").value = lastQuestion["question-text"];
		for (var i = 1; i <= POSSIBLE_RESPONSES_COUNT; i++) {
			document.getElementById("response-" + i + "-input").value = lastQuestion["responses"][i - 1];
		}

		var optNumber = lastQuestion["correct-response-index"] + 1;
		var checkedOption = document.querySelector("input[name='correct-response']:checked");
		if (checkedOption) {
			checkedOption.checked = false;
		}
		document.getElementById("correct-opt-" + optNumber).checked = true;
	}
}
function onAddQuestionClick() {
	refreshView();

	if (verifyCurrentQuestion()) {
		addCurrentQuestionToQuiz();
		currentQuestionNum += 1;
		setQuestionTitle();
		clearQuestionInputs();
	}
}
function onPublishQuizClick() {
	refreshView();
	if (verifyQuizName() && verifyCurrentQuestion()) {
		addCurrentQuestionToQuiz();
		showConfirmationModal("publish");
	}
}
