var currentQuestion = null;
var questionBank = null;
var originalBankSize = -1
var answers = [];
var currentQuizName = null;

function getSelectedAnswer() {
	var selectedAnswer = document.querySelector("input[name='nr-question']:checked");
	var answer = null;
	if (selectedAnswer) {
		var answerId = selectedAnswer.getAttribute("nr-answer");
		answer = document.getElementById(answerId).innerHTML;
	}
	
	return answer;
}

function getQuestion() {
	currentQuestion = questionBank.shift();
}

function getQuestionNumber() {
	return originalBankSize - questionBank.length;
}

function queryQuestionsWithDifficulty(questions, difficulty, amount) {
	var allQuestions = questions.filter(function(question) {
		return question["difficulty"] === difficulty
	});
	var result = [];
	for (var i = 0; i < amount; i++) {
		var index = Math.floor(Math.random() * allQuestions.length);
		result.push(allQuestions.splice(index, 1)[0]);
	}

	return result;
}

function getFirstQuestion(questions) {
	if (questions[0]["difficulty"] && questions[questions.length - 1]["difficulty"]) {
		var easyQuestions = queryQuestionsWithDifficulty(questions, "easy", 8);
		var mediumQuestions = queryQuestionsWithDifficulty(questions, "medium", 7);
		var hardQuestions = queryQuestionsWithDifficulty(questions, "hard", 6);
		var expertQuestions = queryQuestionsWithDifficulty(questions, "expert", 4);
		questionBank = [].concat(easyQuestions, mediumQuestions, hardQuestions, expertQuestions);
	}
	else {
		if (questions.length >= MAX_QUIZ_LENGTH) {
			var randomQuestions = [];
			for (var i = 0; i < MAX_QUIZ_LENGTH; i++) {
				var randomIndex = Math.floor(Math.random() * questions.length);
				randomQuestions.push(questions.splice(randomIndex, 1));
			}
			questionBank = randomQuestions;
		}
		else {
			questionBank = questions;
		}
	}

	originalBankSize = questionBank.length;
	getQuestion();
}

function queryQuizByName(quizName) {
	$.getJSON("/" + quizName)
		.done(function(data){
			currentQuizName = data["quiz-name"];
			getFirstQuestion(data["questions"]);
			fillQuestion();

			document.getElementById("homepage-area").style.display = "none";
			document.getElementById("finished-area").style.display = "none";
			document.getElementById("question-area").style.display = "block";
		})
		.fail(function(error){
			if (error["status"] === 404) {
				document.getElementById("quiz-not-found-label").innerHTML = quizName;
				document.getElementById("not-found-alert").style.display = "block";
			}
		});
}
function startTest(quizName) {
	if (quizName === null) {
		var nameInput = document.getElementById("quiz-name-input").value;
		if (nameInput && nameInput.length > 0) {
			queryQuizByName(nameInput)
		}
	}
	else if (quizName === -1) {
		queryQuizByName(currentQuizName)
	}
	else {
		queryQuizByName(quizName);
	}
	
}
function createQuiz() {
	window.location.href = "/create-quiz";
}

function finishTest() {
	$.post("/grade-quiz", JSON.stringify({ "quiz-name": currentQuizName, "answers": answers }), function(data) {
		var mastery = data.mastery_score;
		var masteryRank = document.getElementById("mastery-rank");

		var progressBar = document.getElementById("percent-progress");
		progressBar.setAttribute("aria-valuenow", mastery);
		progressBar.style.width = mastery + "%";

		document.getElementById("percent-correct-label").innerHTML = mastery.toString();

		var progressClassname = "progress-bar progress-bar-striped active";
		var masteryClassname = "label";
		var rank = "";
		
		if (mastery >= 80) {
			progressClassname += " progress-bar-success";
			masteryClassname += " label-success";
			rank = "Companion";
		}
		else if (mastery >= 50) {
			progressClassname += " progress-bar-warning";
			masteryClassname += " label-warning";
			rank = "Friend";
		}
		else {
			progressClassname += " progress-bar-danger";
			masteryClassname += " label-danger";
			rank = "Associate";
		}
		progressBar.className = progressClassname;
		masteryRank.className = masteryClassname;
		masteryRank.innerHTML = rank + " of Nick";

		answers = [];
		document.getElementById("question-area").style.display = "none";
		document.getElementById("finished-area").style.display = "block";
		window.scrollTo(0, 0);
	});
 }

function fillQuestion() {
	document.getElementById("question-title").innerHTML = "Question #" + getQuestionNumber();
	document.getElementById("question-text").innerHTML = currentQuestion["question-text"];
	document.getElementById("possible-answer-1").innerHTML = currentQuestion["responses"][0];
	document.getElementById("possible-answer-2").innerHTML = currentQuestion["responses"][1];
	document.getElementById("possible-answer-3").innerHTML = currentQuestion["responses"][2];
	document.getElementById("possible-answer-4").innerHTML = currentQuestion["responses"][3];
}

function getNextQuestion(answer) {
	var key = currentQuestion["question-id"];
	var value = currentQuestion["responses"].indexOf(answer);
	answers.push({ "key": key, "value": value });

	if (getQuestionNumber() >= originalBankSize) {
		finishTest();
	}
	else {
		getQuestion();
		fillQuestion();
	}
}

function onAnswerSubmit() {
	var answer = getSelectedAnswer();

	if (answer) {
		document.getElementById("no-answer-alert").style.display = "none";
		getNextQuestion(answer);
	}
	else {
		document.getElementById("no-answer-alert").style.display = "block";
	}
}
function onHomeClick() {
	window.location.href = "/";
}